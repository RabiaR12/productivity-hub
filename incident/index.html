<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SIM Ticketing — Update Knowledge Article</title>
  <style>
    /* ===== BASE LAYOUT ===== */
    body { margin: 0; font-family: Arial, Helvetica, sans-serif; background: #f6f6f6; color: #222; }
    .main-header img { width: 100%; height: auto; display: block; }
    .layout { display: flex; min-height: calc(100vh - 80px); }

    /* Sidebar */
    .sidebar { width: 220px; background: #fff; border-right: 1px solid #ddd; padding: 20px 12px; }
    .sidebar-title { font-weight: 700; font-size: 16px; margin-bottom: 10px; }
    .sidebar-nav a, .sidebar-nav summary { display: block; color: #333; text-decoration: none; padding: 8px 6px; font-size: 14px; border-radius: 4px; cursor: pointer; }
    .sidebar-nav a:hover, .sidebar-nav summary:hover { background: #f2f2f2; }
    .sidebar-nav .current { font-weight: 600; color: #0a58ca; }

    /* Content */
    .content { flex: 1; padding: 20px 28px; background: #fafafa; }
    .title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
    .title-row h1 { font-size: 22px; margin: 0; }

    /* Card */
    .cat-card { background: #fff; border: 1px solid #dadada; border-radius: 8px; box-shadow: 0 1px 0 #e6e6e6; overflow: hidden; }
    .card-subtext { padding: 12px 16px 0; color:#6b7280; font-size: 13px; }

    /* Tabs */
    .cat-tabs { display: flex; gap: 18px; padding: 10px 16px 8px; background: #ffffff; }
    .cat-tab { background: transparent; border: none; font-size: 14px; font-weight: 600; color: #2a2a2a; padding: 6px 2px; cursor: pointer; position: relative; }
    .cat-tab.active::after { content: ""; position: absolute; left: 0; right: 0; bottom: -8px; height: 2px; background: #2a6fd6; border-radius: 2px; }
    .cat-divider { height: 1px; background: #e5e5e5; }

    /* Grid */
    .cat-grid { display: grid; grid-template-columns: 420px 1fr; gap: 24px; padding: 16px; min-height: 480px; }
    .cat-left { display: flex; flex-direction: column; gap: 18px; padding-top: 4px; }
    .group { display: flex; flex-direction: column; gap: 8px; }
    .group-title { font-size: 12px; font-weight: 700; color:#333; }

    /* Dropdown */
    .dropdown { position: relative; }
    .dropdown-trigger { height: 32px; display:flex; align-items:center; justify-content:space-between; background:#fff; border:1px solid #cfcfcf; border-radius:6px; padding:0 8px; cursor:pointer; font-size: 13px; }
    .dropdown-trigger[aria-disabled="true"]{ background:#f3f3f3; color:#999; cursor:not-allowed; }
    .dropdown-value { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .dropdown-caret { opacity: .6; font-size: 12px; margin-left:8px; }
    .dropdown-menu { position:absolute; left:0; right:0; top: calc(100% + 6px); background:#fff; border:1px solid #d3d3d3; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,.08); z-index: 50; display:none; overflow:hidden; }
    .dropdown.open .dropdown-menu { display:block; }
    .menu-search { padding: 6px; border-bottom:1px solid #eee; background:#fafafa; }
    .menu-search input { width:100%; height:30px; font-size:13px; padding:0 8px; border:1px solid #d3d3d3; border-radius:6px; outline:none; }
    .menu-list { max-height: 220px; overflow:auto; list-style:none; margin:0; padding:4px 0; }
    .menu-item { padding:8px 10px; font-size:13px; cursor:pointer; }
    .menu-item:hover { background:#f6f8fa; }
    .menu-item.active { background:#eef4ff; }

    /* Right pane */
    .cat-right { background: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; display: flex; flex-direction: column; height: 100%; min-height: 100%; }
    .cat-right-placeholder { color: #666; text-align: center; padding: 16px; display: grid; place-items: center; height: 100%; }

    /* Table */
    .tickets-card { height: 100%; display: flex; flex-direction: column; }
    .table-wrap { overflow-x: auto; }
    .table-head, .tr { display: grid; grid-template-columns: 44px 70px 120px minmax(240px, 1fr) 120px 140px 160px 120px 160px; align-items: center; text-align: left; }
    .table-head { position: sticky; top: 0; background: #f5f5f5; border-bottom: 1px solid #e5e5e5; z-index: 1; padding: 8px 12px; font-weight: 600; font-size: 13px; }
    .th, .td { padding: 10px 12px; border-bottom: 1px solid #eee; white-space: nowrap; background: #fff; font-size: 14px; text-align: left; }
    .th.th-check, .td.td-check { display: flex; align-items: center; justify-content: center; background: #f5f5f5; }
    .table-body .tr:hover .td { background: #f9fafb; }
    .severity { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; font-weight: 700; color: #fff; border-radius: 5px; font-size: 11px; }
    .sev-1 { background: #d32f2f; } .sev-2 { background: #f57c00; } .sev-3 { background: #fbc02d; color: #222; } .sev-4 { background: #2e7d32; } .sev-5 { background: #1565c0; }

    /* Fieldsets */
    .fieldset { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background:#fff; }
    .legend { font-size:12px; font-weight:700; color:#374151; margin-bottom:10px; }

    /* Rows & inputs */
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .row input[type="number"], .row input[type="date"], .row input[type="time"], .row select { height:32px; border:1px solid #cfcfcf; border-radius:6px; padding:0 8px; font-size:13px; background:#fff; }
    .muted { font-size:12px; color:#6b7280; }
    .disabled-like { opacity:.55; filter: grayscale(0.2); }

    .scheduler { display:grid; gap:10px; }
    .schedule-extra { display:none; }
    .schedule-extra.show { display: grid; gap: 8px; }
    .weekdays { display:flex; gap:8px; flex-wrap:wrap; }
    .weekdays label { font-size:12px; }

    /* ---- Time Window spacing upgrades ---- */
    #timeWindow { display: grid; gap: 10px; }
    #timeWindow .radio-row { display:flex; gap: 20px; align-items:center; flex-wrap:wrap; margin-bottom: 6px; }
    #timeWindow .mode-row { display:flex; gap: 14px; align-items:center; flex-wrap:wrap; margin-top: 6px; padding: 8px 10px; background: #fafafa; border: 1px solid #eee; border-radius: 8px; }
    #timeWindow .mode-row label { min-width: 46px; color: #374151; }
    #timeWindow .muted { margin-top: 2px; }

    /* Footer */
    .cat-footer { display: flex; justify-content: flex-end; gap: 10px; padding: 12px 16px; border-top: 1px solid #e9e9e9; background: #fff; position: sticky; bottom: 0; }
    .btn { display: inline-block; padding: 8px 16px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; text-decoration: none; cursor: pointer; color: #222; background: #fff; transition: all 0.2s ease; }
    .btn:hover { background: #f5f5f5; }
    .btn-ghost { background: #fff; border-color: #ccc; }
    .btn-light { background: #2a6fd6; color: #fff; border-color: #2a6fd6; }
    .btn-light:hover { background: #1f58ad; }

    @media (max-width: 920px) { .cat-grid { grid-template-columns: 1fr; } }
    .hidden { display:none !important; }
  </style>
</head>

<body>
  <header class="main-header">
    <img src="header.png" alt="Header Image" class="header-image">
  </header>

  <div class="layout">
    <aside class="sidebar" aria-label="Ticket queues">
      <div class="sidebar-title">Ticket Queues</div>
      <nav class="sidebar-nav">
        <a class="nav-item" href="index.html">Home</a>
        <details class="nav-group" open>
          <summary>Open Tickets by resolver group</summary>
        </details>
        <a class="nav-item current" href="#">All my Tickets</a>
      </nav>
    </aside>

    <main class="content">
      <div class="title-row">
        <h1>Update Knowledge Article</h1>
      </div>

      <section class="cat-card">
        <div class="card-subtext">Choose a <strong>Category</strong>, <strong>Type</strong> and <strong>Item</strong> (CTI)</div>

        <!-- Tabs: CTI only, and CTI + Time Window -->
        <div class="cat-tabs" role="tablist" aria-label="Modes">
          <button class="cat-tab active" id="tabCTI" role="tab" aria-selected="true">Select CTI</button>
          <button class="cat-tab" id="tabFindWindow" role="tab" aria-selected="false">Find CTI — By Duration</button>
        </div>
        <div class="cat-divider"></div>

        <!-- ===== PANEL: CTI ONLY (no time window) ===== -->
        <div class="cat-grid" id="panelCTI" aria-labelledby="tabCTI">
          <div class="cat-left">
            <div class="group">
              <div class="group-title">Category</div>
              <div class="dropdown" id="ddCategory">
                <div class="dropdown-trigger" role="button" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                  <span class="dropdown-value" id="catValue">Select category…</span><span class="dropdown-caret">▾</span>
                </div>
                <div class="dropdown-menu" role="listbox">
                  <div class="menu-search"><input type="text" placeholder="Search categories…"></div>
                  <ul class="menu-list"></ul>
                </div>
              </div>
            </div>

            <div class="group">
              <div class="group-title">Type</div>
              <div class="dropdown" id="ddType">
                <div class="dropdown-trigger" role="button" tabindex="0" aria-haspopup="listbox" aria-expanded="false" aria-disabled="true">
                  <span class="dropdown-value">Select a category first…</span><span class="dropdown-caret">▾</span>
                </div>
                <div class="dropdown-menu" role="listbox">
                  <div class="menu-search"><input type="text" placeholder="Search types…"></div>
                  <ul class="menu-list"></ul>
                </div>
              </div>
            </div>

            <div class="group">
              <div class="group-title">Item</div>
              <div class="dropdown" id="ddItem">
                <div class="dropdown-trigger" role="button" tabindex="0" aria-haspopup="listbox" aria-expanded="false" aria-disabled="true">
                  <span class="dropdown-value">Select a type first…</span><span class="dropdown-caret">▾</span>
                </div>
                <div class="dropdown-menu" role="listbox">
                  <div class="menu-search"><input type="text" placeholder="Search items…"></div>
                  <ul class="menu-list"></ul>
                </div>
              </div>
            </div>
          </div>

          <div class="cat-right" id="rightPaneCTI">
            <div class="cat-right-placeholder"><div><p><strong>Details panel</strong></p><p>Select an <em>Item</em> to show tickets here.</p></div></div>
          </div>
        </div>

        <!-- ===== PANEL: CTI + TIME WINDOW ===== -->
        <div class="cat-grid" id="panelFindWindow" aria-labelledby="tabFindWindow" style="display:none;">
          <div class="cat-left">
            <!-- CTI path -->
            <div class="group">
              <div class="group-title">Category</div>
              <div class="dropdown" id="ddCategory2">
                <div class="dropdown-trigger" role="button" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                  <span class="dropdown-value">Select category…</span><span class="dropdown-caret">▾</span>
                </div>
                <div class="dropdown-menu" role="listbox">
                  <div class="menu-search"><input type="text" placeholder="Search categories…"></div>
                  <ul class="menu-list"></ul>
                </div>
              </div>
            </div>

            <div class="group">
              <div class="group-title">Type</div>
              <div class="dropdown" id="ddType2">
                <div class="dropdown-trigger" role="button" tabindex="0" aria-haspopup="listbox" aria-expanded="false" aria-disabled="true">
                  <span class="dropdown-value">Select a category first…</span><span class="dropdown-caret">▾</span>
                </div>
                <div class="dropdown-menu" role="listbox">
                  <div class="menu-search"><input type="text" placeholder="Search types…"></div>
                  <ul class="menu-list"></ul>
                </div>
              </div>
            </div>

            <div class="group">
              <div class="group-title">Item</div>
              <div class="dropdown" id="ddItem2">
                <div class="dropdown-trigger" role="button" tabindex="0" aria-haspopup="listbox" aria-expanded="false" aria-disabled="true">
                  <span class="dropdown-value">Select a type first…</span><span class="dropdown-caret">▾</span>
                </div>
                <div class="dropdown-menu" role="listbox">
                  <div class="menu-search"><input type="text" placeholder="Search items…"></div>
                  <ul class="menu-list"></ul>
                </div>
              </div>
            </div>

            <!-- Time window -->
            <div class="group">
              <div class="fieldset" id="timeWindow">
                <div class="legend">Time Window</div>

                <div class="radio-row" role="radiogroup" aria-label="Time window mode">
                  <label><input type="radio" name="timeMode" value="duration" checked> Duration (days)</label>
                  <label><input type="radio" name="timeMode" value="dates"> Date range</label>
                  <a id="clearTime" href="#" class="muted" style="margin-left:auto;text-decoration:none;">Clear</a>
                </div>

                <!-- Duration mode -->
                <div class="mode-row disabled-like" id="durationRow" aria-disabled="true">
                  <label class="muted">Days</label>
                  <input id="durationDays" type="number" min="1" placeholder="e.g., 7" style="width:90px;" disabled>
                </div>

                <!-- Dates mode -->
                <div class="mode-row disabled-like" id="datesRow" aria-disabled="true">
                  <label>Start</label> <input id="startDate" type="date" disabled>
                  <label>End</label> <input id="endDate" type="date" disabled>
                </div>
              </div>
            </div>

            <!-- Scheduler (hidden until time window valid) -->
            <div class="group">
              <div class="fieldset scheduler hidden" id="kbScheduler">
                <div class="legend">Update Knowledge Base</div>
                <label><input type="radio" name="kbMode" value="once" checked> One-time</label>
                <label><input type="radio" name="kbMode" value="schedule"> Scheduled</label>

                <div id="schedExtra" class="schedule-extra">
                  <div class="row">
                    <label>Frequency
                      <select id="freq" style="margin-left:8px;">
                        <option>Daily</option>
                        <option>Weekly</option>
                        <option>Monthly</option>
                      </select>
                    </label>
                    <label>Time <input id="freqTime" type="time" value="09:00"></label>
                    <label>Start on <input id="freqStart" type="date"></label>
                  </div>
                  <div id="weekRow" class="weekdays">
                    <label><input type="checkbox" value="Mon" checked> Mon</label>
                    <label><input type="checkbox" value="Tue" checked> Tue</label>
                    <label><input type="checkbox" value="Wed" checked> Wed</label>
                    <label><input type="checkbox" value="Thu" checked> Thu</label>
                    <label><input type="checkbox" value="Fri" checked> Fri</label>
                    <label><input type="checkbox" value="Sat"> Sat</label>
                    <label><input type="checkbox" value="Sun"> Sun</label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="cat-right" id="rightPaneFind">
            <div class="cat-right-placeholder" id="findPlaceholder">
              <div>
                <p><strong>Details panel</strong></p>
                <p>Select a <em>Category</em>, then set a valid <em>Time Window</em> to preview tickets. Pick an <em>Item</em> to drill into a single KA.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer actions -->
        <div class="cat-footer">
          <a class="btn btn-ghost" href="index.html">Cancel</a>
          <a class="btn btn-light" href="aimagic.html">Update KA</a>
        </div>
      </section>
    </main>
  </div>

  <script>
    /* ========= Data ========= */
    const categories = ['Customer Service','Service Desk','QA Test','Onboarding','Billing','Incident Management'];

    const typesByCategory = {
      'Customer Service': ['QSCAT_QS_A11Y','QSCAT_QS_TEAM','QSTools','QTS-Projects','QUBIT_HORIZON','QYQ6-RME'],
      'Service Desk': ['SD_Password_Reset','SD_Access_Request','SD_Endpoint_Issue'],
      'QA Test': ['QA_Smoke','QA_Regress','QA_Perf'],
      'Onboarding': ['OB_Hardware','OB_Access','OB_Training'],
      'Billing': ['BILL_Invoices','BILL_Disputes','BILL_Refunds'],
      'Incident Management': ['INC_P1','INC_P2','INC_P3','INC_P4']
    };

    /* KA titles must match table data exactly */
    const KA_ITEMS = [
      'Troubleshooting Email Server Connectivity',
      'VPN Client Timeout — Step-by-Step Fix',
      'App Login Crash — Known Issue & Workaround',
      'Self-Service Password Reset Guide',
      'Improving System Performance — Tips & Checks'
    ];

    const itemsByType = {
      'QSCAT_QS_A11Y': ['Screen Reader','Contrast Issue','Keyboard Nav'],
      'QSCAT_QS_TEAM': ['Escalations','Routing','Queue Logic'],
      'QSTools': ['Search','Export','Filters'],
      'QTS-Projects': ['Kickoff','Cutover','Hypercare'],
      'QUBIT_HORIZON': ['Pipeline','Dashboards','Sync'],
      'QYQ6-RME': ['RME Intake','RME Followup'],
      'SD_Password_Reset': ['AD Reset','Self-Service Reset'],
      'SD_Access_Request': ['VPN Access','Email Access','Repo Access'],
      'SD_Endpoint_Issue': ['Laptop Boot','Network Driver'],
      'QA_Smoke': ['Env Check','Sanity Run'],
      'QA_Regress': ['Full Suite','Hotfix Suite'],
      'QA_Perf': ['Load 1k','Load 10k'],
      'OB_Hardware': ['Laptop','Docking'],
      'OB_Access': ['SSO','Slack'],
      'OB_Training': ['Security 101','Product 101'],
      'BILL_Invoices': ['Late Invoice','Missing Invoice'],
      'BILL_Disputes': ['Wrong Amount','Duplicate Charge'],
      'BILL_Refunds': ['Partial Refund','Full Refund'],
      'INC_P1': KA_ITEMS,
      'INC_P2': KA_ITEMS,
      'INC_P3': KA_ITEMS,
      'INC_P4': KA_ITEMS
    };

    /* ========= Tickets HTML ========= */
    const ticketsHTML = `
      <div class="tickets-card">
        <div class="table-wrap">
          <div class="table-head">
            <label class="th th-check"><input id="selectAll" type="checkbox" aria-label="Select all rows"></label>
            <div class="th">Severity ▾</div>
            <div class="th">Short ID</div>
            <div class="th">Title ▾</div>
            <div class="th">Status ▾</div>
            <div class="th">Assignee ▾</div>
            <div class="th">Assigned Group ▾</div>
            <div class="th">Created ▾</div>
            <div class="th">Last Update ▾</div>
          </div>
          <div class="table-body" id="tableBody">
            <div class="tr">
              <label class="td td-check"><input type="checkbox" aria-label="Select row"></label>
              <div class="td severity sev-1">1</div><div class="td">KA-2001</div><div class="td">Troubleshooting Email Server Connectivity</div>
              <div class="td">Published</div><div class="td">John Doe</div><div class="td">Knowledge Management</div><div class="td">10/06/2025</div><div class="td">10/06/2025 09:12</div>
            </div>
            <div class="tr">
              <label class="td td-check"><input type="checkbox"></label>
              <div class="td severity sev-2">2</div><div class="td">KA-2002</div><div class="td">VPN Client Timeout — Step-by-Step Fix</div>
              <div class="td">In Review</div><div class="td">Jane Smith</div><div class="td">Knowledge Management</div><div class="td">10/05/2025</div><div class="td">10/06/2025 08:45</div>
            </div>
            <div class="tr">
              <label class="td td-check"><input type="checkbox"></label>
              <div class="td severity sev-3">3</div><div class="td">KA-2003</div><div class="td">App Login Crash — Known Issue & Workaround</div>
              <div class="td">Published</div><div class="td">Michael Brown</div><div class="td">App Team</div><div class="td">10/04/2025</div><div class="td">10/05/2025 17:10</div>\n            </div>\n            <div class=\"tr\">\n              <label class=\"td td-check\"><input type=\"checkbox\"></label>\n              <div class=\"td severity sev-4\">4</div><div class=\"td\">KA-2004</div><div class=\"td\">Self-Service Password Reset Guide</div>\n              <div class=\"td\">Draft</div><div class=\"td\">Lisa Wong</div><div class=\"td\">User Support</div><div class=\"td\">10/04/2025</div><div class=\"td\">10/05/2025 14:32</div>\n            </div>\n            <div class=\"tr\">\n              <label class=\"td td-check\"><input type=\"checkbox\"></label>\n              <div class=\"td severity sev-5\">5</div><div class=\"td\">KA-2005</div><div class=\"td\">Improving System Performance — Tips & Checks</div>\n              <div class=\"td\">Archived</div><div class=\"td\">Robert Davis</div><div class=\"td\">Operations</div><div class=\"td\">10/03/2025</div><div class=\"td\">10/04/2025 19:00</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;

    /* ========= Dropdown helpers ========= */
    function openDropdown(dd){
      if (dd._disabled) return;
      dd.classList.add('open');
      dd.querySelector('.dropdown-trigger').setAttribute('aria-expanded','true');
      const input = dd.querySelector('.menu-search input');
      input.value = ''; filterMenu(dd,'');
      setTimeout(()=>input.focus(),0);
    }
    function closeDropdown(dd){ dd.classList.remove('open'); dd.querySelector('.dropdown-trigger').setAttribute('aria-expanded','false'); }
    function buildMenu(dd, options){ dd.querySelector('.menu-list').innerHTML = options.map(opt=>`<li class="menu-item" role="option" data-value="${opt}">${opt}</li>`).join(''); }
    function filterMenu(dd,q){ const n=q.trim().toLowerCase(); dd.querySelectorAll('.menu-item').forEach(li=>{ li.style.display = li.textContent.toLowerCase().includes(n) ? '' : 'none'; }); }
    function setValue(dd, value){ dd.querySelector('.dropdown-value').textContent = value; dd._value = value; }
    function setDisabled(dd, disabled, text){ dd._disabled = disabled; const t=dd.querySelector('.dropdown-trigger'); t.setAttribute('aria-disabled', disabled?'true':'false'); if(disabled && text) setValue(dd, text); }
    function setupDropdown(dd, onSelect){
      const trigger = dd.querySelector('.dropdown-trigger');
      const search  = dd.querySelector('.menu-search input');
      const list    = dd.querySelector('.menu-list');
      trigger.addEventListener('click', ()=> dd.classList.contains('open') ? closeDropdown(dd) : openDropdown(dd));
      trigger.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); dd.classList.contains('open')? closeDropdown(dd): openDropdown(dd); }});
      search.addEventListener('input', ()=> filterMenu(dd, search.value));
      list.addEventListener('click', e=>{
        const li=e.target.closest('.menu-item'); if(!li) return;
        list.querySelectorAll('.menu-item').forEach(x=>x.classList.remove('active'));
        li.classList.add('active'); setValue(dd, li.dataset.value); closeDropdown(dd);
        onSelect?.(li.dataset.value, li);
      });
    }

    /* ========= Right pane render helpers ========= */
    function renderPlaceholder(pane, msg='Select an Item to show tickets here.'){
      pane.innerHTML = `<div class="cat-right-placeholder"><div><p><strong>Details panel</strong></p><p>${msg}</p></div></div>`;
    }
    function renderTickets(pane){
      pane.style.border='1px solid #e5e5e5'; pane.innerHTML = ticketsHTML;
      const selectAll = pane.querySelector('#selectAll');
      const rowCbs = () => Array.from(pane.querySelectorAll('.table-body .td-check input[type="checkbox"]'));
      selectAll.addEventListener('change', e => rowCbs().forEach(cb => cb.checked = e.target.checked));
      pane.addEventListener('change', e=>{
        if(e.target.matches('.table-body .td-check input[type="checkbox"]')){
          const all = rowCbs(); selectAll.checked = all.length>0 && all.every(cb=>cb.checked);
        }
      });
    }
    function filterTicketsByTitle(pane, title){
      const rows = pane.querySelectorAll('.table-body .tr');
      rows.forEach(tr=>{
        const titleCell = tr.children[3];
        const ok = titleCell && titleCell.textContent.trim() === title;
        tr.style.display = ok ? '' : 'none';
      });
    }

    /* ========= PANEL: CTI ONLY ========= */
    const ddCategory = document.getElementById('ddCategory');
    const ddType     = document.getElementById('ddType');
    const ddItem     = document.getElementById('ddItem');
    const rightPaneCTI = document.getElementById('rightPaneCTI');

    buildMenu(ddCategory, categories);
    setValue(ddCategory, 'Select category…'); setDisabled(ddType,true,'Select a category first…'); setDisabled(ddItem,true,'Select a type first…');

    setupDropdown(ddCategory, (cat)=>{
      const types = typesByCategory[cat]||[];
      buildMenu(ddType, types);
      setDisabled(ddType, types.length===0, types.length?'Select type…':'No types'); setValue(ddType, types.length?'Select type…':'No types');
      setDisabled(ddItem, true, 'Select a type first…'); renderPlaceholder(rightPaneCTI);
    });

    // On Type select: render FULL table + enable Items (unified KA list)
    setupDropdown(ddType, (type)=>{
      const items = KA_ITEMS; // unified list
      buildMenu(ddItem, items);
      setDisabled(ddItem, items.length===0, items.length?'Select item…':'No items'); setValue(ddItem, items.length?'Select item…':'No items');
      renderTickets(rightPaneCTI); // show full table immediately after Type selection
    });

    // On Item select: filter to single KA row
    setupDropdown(ddItem, ()=>{
      renderTickets(rightPaneCTI);
      filterTicketsByTitle(rightPaneCTI, ddItem._value);
    });

    document.addEventListener('click', (e)=>[ddCategory,ddType,ddItem].forEach(dd=>{ if(!dd.contains(e.target)) closeDropdown(dd); }));

    /* ========= PANEL: CTI + TIME WINDOW ========= */
    const ddCategory2 = document.getElementById('ddCategory2');
    const ddType2     = document.getElementById('ddType2');
    const ddItem2     = document.getElementById('ddItem2');
    const rightPaneFind = document.getElementById('rightPaneFind');
    const kbScheduler = document.getElementById('kbScheduler');

    buildMenu(ddCategory2, categories);
    setValue(ddCategory2, 'Select category…'); setDisabled(ddType2,true,'Select a category first…'); setDisabled(ddItem2,true,'Select a type first…');

    // Helper sets
    const categoriesSet = new Set(categories);
    const typesAll = Object.values(typesByCategory).flat();
    const typesSet = new Set(typesAll);
    const kaSet = new Set(KA_ITEMS);

    function isCTIListValid(){ return categoriesSet.has(ddCategory2._value) && typesSet.has(ddType2._value); }
    function isCTIDrillValid(){ return isCTIListValid() && kaSet.has(ddItem2._value); }

    // Time Window controls
    const timeModeRadios = document.querySelectorAll('input[name="timeMode"]');
    const durationRow = document.getElementById('durationRow');
    const datesRow = document.getElementById('datesRow');
    const durationDays = document.getElementById('durationDays');
    const startDate = document.getElementById('startDate');
    const endDate   = document.getElementById('endDate');
    const clearTimeLink = document.getElementById('clearTime');

    function setDurationEnabled(on) {
      durationDays.disabled = !on;
      durationRow.classList.toggle('disabled-like', !on);
      durationRow.setAttribute('aria-disabled', (!on).toString());
    }
    function setDatesEnabled(on) {
      startDate.disabled = !on;
      endDate.disabled = !on;
      datesRow.classList.toggle('disabled-like', !on);
      datesRow.setAttribute('aria-disabled', (!on).toString());
    }
    function currentTimeMode(){ return document.querySelector('input[name="timeMode"]:checked').value; }
    function isTimeWindowValid(){
      if(currentTimeMode()==='duration'){
        const n = parseInt(durationDays.value,10);
        return Number.isInteger(n) && n>=1;
      } else {
        if(!startDate.value || !endDate.value) return false;
        return new Date(startDate.value) <= new Date(endDate.value);
      }
    }
    function applyTimeMode(mode){
      const usingDuration = (mode === 'duration');
      // Only enable controls if Category is chosen
      const categoryChosen = categoriesSet.has(ddCategory2._value);
      setDurationEnabled(categoryChosen && usingDuration);
      setDatesEnabled(categoryChosen && !usingDuration);
    }
    // init (no category yet -> both disabled)
    applyTimeMode(currentTimeMode());

    timeModeRadios.forEach(r => {
      r.addEventListener('change', () => { applyTimeMode(r.value); evaluateFindState(); });
    });

    [durationDays,startDate,endDate].forEach(el=>{
      el.addEventListener('input', ()=> evaluateFindState());
      el.addEventListener('change', ()=> evaluateFindState());
    });

    clearTimeLink.addEventListener('click', (e)=>{
      e.preventDefault();
      durationDays.value = '';
      startDate.value = '';
      endDate.value = '';
      evaluateFindState();
    });

    // Build CTI for Find (time window available after category selection)
    setupDropdown(ddCategory2, (cat)=>{
      const types = typesByCategory[cat]||[];
      buildMenu(ddType2, types);
      setDisabled(ddType2, types.length===0, types.length?'Select type…':'No types'); setValue(ddType2, types.length?'Select type…':'No types');

      // Reset Item
      setDisabled(ddItem2, true, 'Select a type first…'); setValue(ddItem2, 'Select a type first…');
      // Enable proper time mode controls now that category is chosen
      applyTimeMode(currentTimeMode());
      evaluateFindState();
    });

    setupDropdown(ddType2, (type)=>{
      // Populate Item with KA titles (drill-down)
      buildMenu(ddItem2, KA_ITEMS);
      setDisabled(ddItem2, KA_ITEMS.length===0, KA_ITEMS.length?'Select item…':'No items'); setValue(ddItem2, KA_ITEMS.length?'Select item…':'No items');
      evaluateFindState();
    });

    setupDropdown(ddItem2, ()=>{
      evaluateFindState();
    });

    document.addEventListener('click', (e)=>[ddCategory2,ddType2,ddItem2].forEach(dd=>{ if(!dd.contains(e.target)) closeDropdown(dd); }));

    // Scheduler internals
    const schedExtra = document.getElementById('schedExtra');
    const weekRow = document.getElementById('weekRow');
    const freqSel = document.getElementById('freq');

    document.querySelectorAll('input[name="kbMode"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        const on = document.querySelector('input[name="kbMode"]:checked').value === 'schedule';
        schedExtra.classList.toggle('show', on);
      });
    });
    freqSel.addEventListener('change', ()=>{
      weekRow.style.display = (freqSel.value === 'Weekly') ? 'flex' : 'none';
    });

    /* ========= Tabs ========= */
    const tabCTI = document.getElementById('tabCTI');
    const tabFind   = document.getElementById('tabFindWindow');
    const panelCTIEl = document.getElementById('panelCTI');
    const panelFindEl   = document.getElementById('panelFindWindow');

    function activateTab(which){
      const isCTI = which === 'cti';
      tabCTI.classList.toggle('active', isCTI);
      tabFind.classList.toggle('active', !isCTI);
      tabCTI.setAttribute('aria-selected', isCTI);
      tabFind.setAttribute('aria-selected', !isCTI);
      panelCTIEl.style.display = isCTI ? '' : 'none';
      panelFindEl.style.display   = isCTI ? 'none' : '';
      if(!isCTI) evaluateFindState(); // update when opening Find
    }
    tabCTI.addEventListener('click', ()=>activateTab('cti'));
    tabFind.addEventListener('click',  ()=>activateTab('find'));

    /* ========= Priority rendering for FIND CTI — Time Window ========= */
    function showScheduler(show){
      kbScheduler.classList.toggle('hidden', !show);
    }

    function evaluateFindState(){
      const categoriesSet = new Set(categories);
      const hasCategory = categoriesSet.has(ddCategory2._value);
      const timeValid = isTimeWindowValid();
      const itemValid = isCTIDrillValid();     // Category+Type+Item
      const typeValid = isCTIListValid();      // Category+Type

      if(!hasCategory){
        applyTimeMode(currentTimeMode());
        renderPlaceholder(rightPaneFind, 'Select a Category to enable Time Window controls.');
        showScheduler(false);
        return;
      }

      if(!timeValid){
        renderPlaceholder(rightPaneFind, 'Set a valid Time Window (duration or date range) to preview tickets.');
        showScheduler(false);
        return;
      }

      renderTickets(rightPaneFind);
      if(itemValid){
        filterTicketsByTitle(rightPaneFind, ddItem2._value);
      }
      showScheduler(true);
    }
  </script>
</body>
</html>
